<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seajets Scraper - Results</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="/static/css/custom.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="bg-dark text-light">
    <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <div class="d-flex align-items-center text-light">
                <img src="/static/img/logo.svg" alt="Seajets Scraper Logo" height="50" class="me-3">
                <h1 class="fs-4">Seajets Ferry Scraper - Results</h1>
            </div>
        </header>

        <div class="p-4 mb-4 bg-dark rounded-3 border border-secondary">
            <div class="container-fluid">
                <h2 class="mb-4">Scraping Results</h2>
                
                <div class="row mb-3">
                    <div class="col-12 text-end">
                        <div class="btn-group">
                            <button id="export-csv" class="btn btn-sm btn-outline-info">Export CSV</button>
                            <button id="export-excel" class="btn btn-sm btn-outline-success">Export Excel</button>
                        </div>
                        <a href="/" class="btn btn-sm btn-outline-secondary ms-3">Back to Search</a>
                    </div>
                </div>

                <!-- Itineraries Table -->
                <h3 class="mb-3 mt-4">Itineraries</h3>
                <div class="table-responsive mb-5">
                    <table id="itineraries-table" class="table table-dark table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Vessel</th>
                                <th>Departure</th>
                                <th>Arrival</th>
                                <th>Duration</th>
                                <th>Price</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for itinerary in itineraries %}
                            <tr>
                                <td>{{ itinerary.Date }}</td>
                                <td>{{ itinerary.Vessel }}</td>
                                <td>{{ itinerary["Departure Time"] }}</td>
                                <td>{{ itinerary["Arrival Time"] }}</td>
                                <td>{{ itinerary.Duration }}</td>
                                <td>{{ itinerary.Price }}</td>
                                <td>
                                    {% if itinerary.Available %}
                                    <span class="badge bg-success">Available</span>
                                    {% else %}
                                    <span class="badge bg-danger">Unavailable</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Seat Availability Table -->
                <h3 class="mb-3">Seat Availability</h3>
                <div class="table-responsive">
                    <table id="seats-table" class="table table-dark table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Vessel</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Availability</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for seat in seats %}
                            <tr>
                                <td>{{ seat.Date }}</td>
                                <td>{{ seat.Vessel }}</td>
                                <td>{{ seat.Category }}</td>
                                <td>{{ seat.Price }}</td>
                                <td>
                                    {% set seat_info = seat["Available Seats"].split('/') %}
                                    {% set available = seat_info[0]|int %}
                                    {% set total = seat_info[1]|int %}
                                    {% set percentage = ((total - available) / total * 100)|round|int %}
                                    
                                    <div class="progress">
                                        <div class="progress-bar {% if percentage > 90 %}bg-danger{% elif percentage > 70 %}bg-warning{% else %}bg-success{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ percentage }}%;" 
                                             aria-valuenow="{{ percentage }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ percentage }}%
                                        </div>
                                    </div>
                                    <small class="d-block text-center mt-1">{{ available }}/{{ total }} available</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer class="pt-3 mt-4 text-muted border-top">
            <p>Â© 2025 Seajets Scraper</p>
        </footer>
    </div>

    <script>
        $(document).ready(function() {
            // Initialize DataTables
            $('#itineraries-table').DataTable({
                "order": [[ 0, "asc" ], [ 2, "asc" ]],
                "pageLength": 10,
                "lengthMenu": [10, 25, 50, 100],
                "columnDefs": [
                    { "width": "15%", "targets": 0 }, // Date
                    { "width": "20%", "targets": 1 }, // Vessel
                    { "width": "10%", "targets": 2 }, // Departure
                    { "width": "10%", "targets": 3 }, // Arrival
                    { "width": "10%", "targets": 4 }, // Duration
                    { "width": "10%", "targets": 5 }, // Price
                    { "width": "15%", "targets": 6 }  // Status
                ]
            });
            
            $('#seats-table').DataTable({
                "order": [[ 0, "asc" ], [ 1, "asc" ], [ 2, "asc" ]],
                "pageLength": 10,
                "lengthMenu": [10, 25, 50, 100],
                "columnDefs": [
                    { "width": "15%", "targets": 0 }, // Date
                    { "width": "20%", "targets": 1 }, // Vessel
                    { "width": "15%", "targets": 2 }, // Category
                    { "width": "10%", "targets": 3 }, // Price
                    { "width": "40%", "targets": 4 }  // Availability
                ]
            });
            
            // Export CSV
            $('#export-csv').on('click', function() {
                console.log('Export CSV clicked');
                exportData('csv');
            });
            
            // Export Excel
            $('#export-excel').on('click', function() {
                console.log('Export Excel clicked');
                exportData('excel');
            });
            
            function exportData(type) {
                console.log(`Starting ${type} export process`);
                $.ajax({
                    url: '/export_csv',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ type: type }),
                    success: function(response) {
                        console.log('Export successful', response);
                        
                        if (type === 'csv') {
                            // Save itineraries CSV
                            var itinerariesBlob = new Blob([response.itineraries_csv], {type: 'text/csv;charset=utf-8'});
                            saveAs(itinerariesBlob, `${response.filename_prefix}_itineraries.csv`);
                            
                            // Save seats CSV
                            var seatsBlob = new Blob([response.seats_csv], {type: 'text/csv;charset=utf-8'});
                            saveAs(seatsBlob, `${response.filename_prefix}_seats.csv`);
                        } else if (type === 'excel') {
                            // Convert base64 to binary and save Excel file
                            var byteCharacters = atob(response.excel_data);
                            var byteNumbers = new Array(byteCharacters.length);
                            for (var i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            var byteArray = new Uint8Array(byteNumbers);
                            var blob = new Blob([byteArray], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                            saveAs(blob, `${response.filename_prefix}.xlsx`);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Export error:', error);
                        alert(`Error exporting data: ${error}`);
                    }
                });
            }
        });
    </script>
</body>
</html>